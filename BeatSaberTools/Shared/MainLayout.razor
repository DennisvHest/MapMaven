@using System.Reactive.Threading.Tasks
@using BeatSaberTools.Core.Services

@inherits LayoutComponentBase

@inject IDialogService DialogService

<MudThemeProvider Theme="BSToolsTheme.Theme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    @if (InitialSetupDone)
    {
        <SideNav></SideNav>
        <MudMainContent Class="pa-0">
            @Body
        </MudMainContent>
    }
</MudLayout>

@code {
    [Inject]
    protected BeatSaberDataService BeatSaberDataService { get; set; }

    [Inject]
    protected ScoreSaberService ScoreSaberService { get; set; }

    [Inject]
    protected BeatSaberToolFileService BeatSaberToolFileService { get; set; }

    protected bool InitialSetupDone { get; set; }

    protected override void OnInitialized()
    {
        BeatSaberToolFileService.BeatSaberInstallLocationObservable.Subscribe(location =>
        {
            InitialSetupDone = location != null;

            StateHasChanged();

            if (InitialSetupDone)
            {
                Task.Run(BeatSaberDataService.LoadAllMapInfo);
                Task.Run(ScoreSaberService.LoadPlayerData);
                Task.Run(ScoreSaberService.LoadRankedMaps);
                Task.Run(BeatSaberDataService.LoadAllPlaylists);
            }
        });
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (BeatSaberToolFileService.BeatSaberInstallLocation == null)
        {
            DialogService.Show<InitialSetup>(null, new DialogOptions
            {
                DisableBackdropClick = true
            });
        }
    }
}